<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>MJT Streaming - Servi√ßos Digitais</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // üö® MUDAR: COLOQUE SUAS CHAVES DE CONEX√ÉO REAIS AQUI üö®
        const firebaseConfig = {
          apiKey: "SUA_API_KEY_AQUI", 
          authDomain: "SEU_PROJETO.firebaseapp.com",
          projectId: "SEU_PROJETO_ID_AQUI", 
          storageBucket: "SEU_PROJETO.appspot.com",
          messagingSenderId: "SEU_ID",
          appId: "SEU_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(); 
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* 1. ESTILOS GERAIS E LAYOUT */
        body {
            background: none !important; 
            filter: none !important; 
            max-width: 1200px; 
            margin: 0 auto 40px auto; 
            padding: 0; 
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }

        #fundo-global-cobertura {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; 
            /* ATEN√á√ÉO: Verifique se 'foto1.jpg' est√° na raiz do GitHub! */
            background-image: url('foto1.jpg'); 
            background-size: cover; 
            background-position: center;
            filter: brightness(0.65); 
        }

        #home-screen {
            filter: none; 
            background-image: none;
            display: flex; 
            flex-direction: column;
            align-items: center;
            justify-content: center; 
            padding: 20px; 
            min-height: 100vh;
            text-align: center;
            position: relative; 
            overflow: hidden; 
            z-index: 10; 
            margin: 0 auto; 
            max-width: 100%;
        }

        .central-box {
            text-align: center;
            max-width: 400px;
            width: 90%;
            position: relative; 
            z-index: 10;
        }

        .home-header {
            width: 100%;
            margin-bottom: 20px;
            color: white !important; 
        }

        .home-header h1 {
            color: white; 
            font-size: 2.8em; 
            margin-bottom: 5px;
            border-bottom: none;
        }

        .home-header h2 {
            color: #BBDEFB; 
            font-size: 1.2em; 
            margin-top: 0;
            border-bottom: 2px solid #BBDEFB;
            padding-bottom: 15px;
        }

        .info-login-box {
            background-color: rgba(0, 0, 0, 0.4); 
            backdrop-filter: blur(8px); 
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .info-login-box h3 {
            color: #e67e22; 
            margin-top: 0;
            margin-bottom: 5px;
            border-bottom: none;
            padding-bottom: 0;
        }

        #horario-brasilia {
            font-size: 2.2em; 
            font-weight: bold;
            color: #FFFFFF; 
            text-align: center;
            padding: 0;
        }
        
        #home-screen button {
            background-color: #28a745; 
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em; 
            font-weight: bold;
            transition: background-color 0.3s;
            padding: 12px 30px; 
            margin-top: 15px;
        }
        #home-screen button:hover {
            background-color: #1e7e34;
        }

        /* ---------------------------------------------------- */
        /* ESTILOS PARA TELA DE LOGIN */
        /* ---------------------------------------------------- */
        #login-screen { 
            display: none; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            background: none; 
            padding: 20px; 
            box-sizing: border-box; 
            filter: none; 
            z-index: 10;
        }
        .login-box { 
            padding: 30px; 
            max-width: 90%; 
            background-color: rgba(255, 255, 255, 0.95); 
            border-radius: 8px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
        }
        /* Mant√©m o restante dos estilos de login */


        /* ---------------------------------------------------- */
        /* ESTILOS DO PAINEL ADMINISTRATIVO */
        /* ---------------------------------------------------- */
        #main-content.container { 
            padding: 10px; 
            background-color: white; 
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
            z-index: 5;
            position: relative;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); background-color: white; }
        th, td { padding: 10px 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; }
        th { background-color: #1a73e8; color: white; text-transform: uppercase; }
        .nav-wrapper { display: flex; justify-content: center; align-items: center; background-color: #1a73e8; padding: 5px 0; flex-wrap: wrap; }
        nav ul { list-style: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; justify-content: center; }
        nav ul li a { display: block; color: white; text-align: center; padding: 10px 12px; text-decoration: none; font-weight: bold; transition: background-color 0.3s; font-size: 0.9em; }
        #logout-button { padding: 6px 10px; margin-left: 10px; background-color: #e67e22; }
        .metricas-dashboard { display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-around; margin-bottom: 40px; }
        .card-metrica { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); flex: 1; min-width: 200px; text-align: center; }
        #faturamento .valor { color: #28a745; } 
        #total-clientes .valor { color: #1a73e8; } 
        #vencimento-mes .valor { color: #e67e22; } 
        #vencimento-proximo-mes .valor { color: #8e44ad; } 
        .graficos-container { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 30px; }
        .grafico-wrapper { width: 45%; min-width: 300px; margin-bottom: 20px; height: 400px; position: relative; box-sizing: border-box; }
        @media (max-width: 768px) {
            .metricas-dashboard { flex-direction: column; }
            .card-metrica { min-width: 100%; margin-bottom: 10px; }
            .grafico-wrapper { width: 100%; height: 350px; }
            .nav-wrapper { flex-direction: column; padding: 10px 0; }
            nav ul { flex-direction: row; justify-content: center; width: 100%; }
            nav ul li a { padding: 8px 8px; font-size: 0.8em; }
            #logout-button { margin: 10px auto; width: 90%; }
            table { display: block; overflow-x: auto; white-space: nowrap; }
            .registro-rapido-grid { grid-template-columns: 1fr; }
        }
        .form-container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        label { display: block; margin-top: 15px; font-weight: bold; color: #555; }
        input[type="text"], input[type="date"], input[type="number"], select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; text-transform: uppercase; }
        textarea { resize: vertical; }
        button[type="submit"] { display: block; width: 100%; padding: 12px; margin-top: 25px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1.1em; transition: background-color 0.3s; }
        button[type="submit"]:hover { background-color: #1e7e34; }
        #novos-clientes, #dados-clientes, #historico-pagamentos, #graficos { display: none; }
        .botao-editar { background-color: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: background-color 0.3s; margin-right: 5px; }
        .botao-editar:hover { background-color: #0056b3; }
        .botao-deletar { background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: background-color 0.3s; }
        .botao-deletar:hover { background-color: #c82333; }
        .proxima-renovacao { font-weight: bold; color: #1a73e8; }
        .registro-rapido-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; align-items: end; }
        .registro-rapido-grid select, .registro-rapido-grid input { margin-top: 0; }
        .registro-rapido-grid button { margin-top: 5px; padding: 10px; }
        #logout-button { background-color: #e67e22; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-left: 20px; font-weight: bold; transition: background-color 0.3s; }
        #logout-button:hover { background-color: #d35400; } 

    </style>
</head>
<body>
    
    <div id="fundo-global-cobertura"></div>
    
    <div id="home-screen">
        <div class="central-box">
            <div class="home-header">
                <h1>MJT STREAMING</h1>
                <h2>GERENCIADOR DE SERVI√áOS DIGITAIS</h2>
            </div>

            <div class="info-login-box">
                
                <h3 style="margin-bottom: 5px;">HOR√ÅRIO DE BRAS√çLIA</h3>
                <div id="horario-brasilia"></div> 
                
                <p style="margin-top: 30px; font-weight: bold; color: #FFFFFF;">
                    <span style="border-bottom: 1px solid #BBDEFB;">ACESSO ADMINISTRATIVO:</span>
                </p>
                <button onclick="mostrarTelaLogin()">
                    ENTRAR NO PAINEL
                </button>
                <p style="color: #BBDEFB; font-size: 0.8em; margin-top: 20px; margin-bottom: 0;">
                    Seu Dashboard de gest√£o financeira.
                </p>
            </div>
        </div>
    </div>


    <div id="login-screen">
        <div class="login-box">
            <h2>ACESSO RESTRITO</h2>
            <form id="loginForm" onsubmit="processLogin(); return false;">
                <label for="username" style="text-align: left; display: block;">Login:</label>
                <input type="text" id="username" placeholder="Digite seu login" required style="text-transform: none;">
                
                <label for="password" style="text-align: left; display: block;">Senha:</label>
                <input type="password" id="password" placeholder="Digite sua senha" required>
                
                <button type="submit">ENTRAR</button>
            </form>
            <p id="login-error" style="color: red; margin-top: 15px; display: none;">Login ou Senha incorretos.</p>
             <button onclick="mostrarTelaHome()" style="background-color: #999; margin-top: 15px;">VOLTAR</button>
        </div>
    </div>
    
    
    <div id="main-content" class="container"> 
        
        <div class="nav-wrapper">
            <nav>
                <ul>
                    <li><a href="#dashboard" class="active">Dashboard</a></li> 
                    <li><a href="#novos-clientes">Novo Cliente</a></li>
                    <li><a href="#dados-clientes">Clientes</a></li>
                    <li><a href="#historico-pagamentos">Hist√≥rico</a></li>
                    <li><a href="#graficos">Gr√°ficos</a></li>
                </ul>
            </nav>
            <button id="logout-button" onclick="logout()">SAIR</button>
        </div>

        <div>
            
            <div id="dashboard" class="secao">
                <h1>VIS√ÉO GERAL DO GERENCIAMENTO</h1>
                
                <div class="metricas-dashboard">
                    <div class="card-metrica" id="faturamento">
                        <h3>Faturamento Mensal Estimado</h3>
                        <p class="valor" id="valorFaturamento">R$ 0,00</p>
                    </div>
                    
                    <div class="card-metrica" id="total-clientes">
                        <h3>Total de Clientes Ativos</h3>
                        <p class="valor" id="valorClientes">0</p>
                    </div>
                    
                    <div class="card-metrica" id="vencimento-mes">
                        <h3>Vencimentos M√™s Atual</h3>
                        <p class="valor" id="valorVencimentosMes">0</p>
                    </div>
                    
                    <div class="card-metrica" id="vencimento-proximo-mes">
                        <h3>Previs√£o Pr√≥ximo M√™s</h3>
                        <p class="valor" id="valorVencimentosProximoMes">0</p>
                    </div>
                </div>
                
                <div class="graficos-container">
                    
                    <div class="grafico-wrapper">
                        <h2>SERVI√áOS VENCENDO em <span id="tituloMesAtual">M√äS ATUAL</span></h2>
                        <canvas id="vencimentosMesAtualChart"></canvas>
                    </div>
                    
                    <div class="grafico-wrapper">
                        <h2>SERVI√áOS VENCENDO em <span id="tituloProximoMes">PR√ìXIMO M√äS</span></h2>
                        <canvas id="vencimentosProximoMesChart"></canvas>
                    </div>
                    
                    <div class="grafico-wrapper">
                        <h2>CLIENTES POR SERVI√áO (GERAL)</h2>
                        <canvas id="dashboardServicosChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div id="novos-clientes" class="secao">
                 <h1>CADASTRAR NOVO CLIENTE</h1>
                 <div class="form-container">
                     <form id="cadastroClienteForm" onsubmit="return false;">
                         <label for="nome">Nome do Cliente:</label>
                         <input type="text" id="nome" name="nome" required>
                         
                         <label for="servico">Servi√ßo Stream:</label>
                         <select id="servico" name="servico" required>
                             <option value="">SELECIONE...</option>
                             <option value="Netflix">NETFLIX</option>
                             <option value="AmazonPrime">AMAZON PRIME</option>
                             <option value="HBO">HBO MAX</option>
                             <option value="Outro">OUTRO</option>
                         </select>
                         
                         <label for="appNome">Nome do Aplicativo (App):</label>
                         <input type="text" id="appNome" name="appNome" placeholder="EX: NETFLIX PADR√ÉO, PRIME V√çDEO, ETC.">
                         <label for="valor">Valor do Servi√ßo (R$):</label>
                         <input type="number" id="valor" name="valor" step="0.01" min="0" placeholder="EX: 29.90" required>

                         <label for="vencimento">Data de Vencimento (Pr√≥xima Renova√ß√£o):</label>
                         <input type="date" id="vencimento" name="vencimento" required>

                         <label for="pagamento">Forma de Pagamento:</label>
                         <select id="pagamento" name="pagamento" required>
                             <option value="">SELECIONE...</option>
                             <option value="PIX">PIX</option>
                             <option value="Transferencia">TRANSFER√äNCIA BANC√ÅRIA</option>
                             <option value="Cartao">CART√ÉO DE CR√âDITO</option>
                         </select>

                         <label for="banco">Banco/Plataforma de Recebimento:</label>
                         <input type="text" id="banco" name="banco" placeholder="EX: NUBANK, PICPAY, ETC." required>

                         <label for="renovacao">Per√≠odo de Renova√ß√£o (dias - manter 30, √© calculado por m√™s):</label>
                         <input type="text" id="renovacao" name="renovacao" value="30" disabled>
                         
                         <label for="observacoes">Observa√ß√µes:</label>
                         <textarea id="observacoes" name="observacoes" rows="3" placeholder="QUALQUER NOTA IMPORTANTE SOBRE O CLIENTE OU SERVI√áO..."></textarea>
                         <button type="submit">CADASTRAR CLIENTE</button>
                     </form>
                 </div>
            </div>

            <div id="dados-clientes" class="secao">
                <h1>LISTA DE CLIENTES ATIVOS</h1>
                
                <div class="form-container" style="margin-bottom: 30px;">
                    <h2>REGISTRO R√ÅPIDO DE PAGAMENTO E RENOVA√á√ÉO</h2>
                    <form id="registroPagamentoForm" onsubmit="return false;">
                        <div class="registro-rapido-grid">
                            <div>
                                <label for="clientePagamento">Selecionar Cliente:</label>
                                <select id="clientePagamento" required>
                                    <option value="">SELECIONE O CLIENTE</option>
                                </select>
                            </div>
                            <div>
                                <label for="dataPagamentoRapido">Data do Pagamento:</label>
                                <input type="date" id="dataPagamentoRapido" required>
                            </div>
                            <div>
                                <label for="pagamentoRapido">Forma de Pagamento:</label>
                                <select id="pagamentoRapido" required>
                                    <option value="PIX">PIX</option>
                                    <option value="Transferencia">TRANSFER√äNCIA BANC√ÅRIA</option>
                                    <option value="Cartao">CART√ÉO DE CR√âDITO</option>
                                </select>
                            </div>
                             <div>
                                <label for="bancoPagamentoRapido">Banco/Plataforma:</label>
                                <input type="text" id="bancoPagamentoRapido" placeholder="EX: NUBANK, PICPAY">
                            </div>
                            <div style="grid-column: span 4;">
                                 <button type="submit">REGISTRAR PAGAMENTO E RENOVAR</button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div id="tabela-dados-clientes"></div>
            </div>
            
            <div id="historico-pagamentos" class="secao">
                <h1>HIST√ìRICO DE PAGAMENTOS</h1>
                
                <div class="form-container" style="margin-bottom: 20px;">
                    <h2>FILTROS</h2>
                    <label for="filtroPagamento">Filtrar por Forma de Pagamento:</label>
                    <select id="filtroPagamento" onchange="carregarHistoricoPagamentos()">
                        <option value="todos">MOSTRAR TODOS</option>
                        <option value="PIX">PIX</option>
                        <option value="Transferencia">TRANSFER√äNCIA BANC√ÅRIA</option>
                        <option value="Cartao">CART√ÉO DE CR√âDITO</option>
                    </select>
                </div>

                <div id="tabela-historico"></div>
            </div>
            
            <div id="graficos" class="secao">
                <h1>GR√ÅFICOS DETALHADOS</h1>
                <div class="graficos-container">
                    <div class="grafico-wrapper">
                        <h2>VENCIMENTOS POR M√äS</h2>
                        <canvas id="vencimentosAnualChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // CONFIGURA√á√ÉO DE LOGIN
        const LOGIN_CORRETO = "ADMIN";
        const SENHA_CORRETA = "12345"; 
        
        // VARI√ÅVEIS GLOBAIS PARA CONTROLE DE GR√ÅFICOS
        let vencimentosMesAtualChart = null; 
        let vencimentosProximoMesChart = null; 
        let dashboardServicosChart = null; 
        let vencimentosAnualChart = null; 
        let horarioInterval; 

        // N√ì PRINCIPAL DO REALTIME DATABASE
        const CLIENTES_PATH = 'clientes'; 

        /* ---------------------------------------------------- */
        /* FUN√á√ïES DE CONEX√ÉO COM REALTIME DATABASE (RTDB) */
        /* ---------------------------------------------------- */
        
        async function getClientesDoDatabase() {
            try {
                const snapshot = await db.ref(CLIENTES_PATH).once('value');
                const data = snapshot.val(); 
                if (!data) return []; 
                return Object.keys(data).map(id => ({
                    id: id, 
                    ...data[id]
                }));
            } catch (error) {
                console.error("Erro ao carregar clientes do Firebase:", error);
                alert("ERRO AO CARREGAR DADOS. Verifique as chaves de conex√£o do Firebase no console.");
                return [];
            }
        }

        async function salvarClienteNoDatabase(cliente) {
             try {
                if (cliente.id) {
                    const { id, ...clienteData } = cliente; 
                    await db.ref(CLIENTES_PATH + '/' + id).update(clienteData);
                    return id;
                } else {
                    const newRef = await db.ref(CLIENTES_PATH).push();
                    await newRef.set(cliente);
                    return newRef.key;
                }
            } catch (error) {
                console.error("Erro ao salvar cliente no Firebase:", error);
                alert("ERRO AO SALVAR DADOS. Verifique as chaves de conex√£o.");
            }
        }

        async function deletarClienteNoDatabase(id) {
             try {
                await db.ref(CLIENTES_PATH + '/' + id).remove();
            } catch (error) {
                 console.error("Erro ao deletar cliente no Firebase:", error);
                 alert("ERRO AO DELETAR. Verifique a conex√£o.");
            }
        }

        /* ---------------------------------------------------- */
        /* FUN√á√ïES DE CONTROLE DE TELA */
        /* ---------------------------------------------------- */
        
        function pararRelogio() {
            if (horarioInterval) {
                clearInterval(horarioInterval);
            }
        }

        window.mostrarTelaHome = function() {
            document.getElementById('home-screen').style.display = 'flex';
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'none';
            
            iniciarRelogioBrasilia();
        }

        window.mostrarTelaLogin = function() {
            document.getElementById('home-screen').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-content').style.display = 'none';
            pararRelogio(); 
        }
        
        function processLogin() {
            const username = document.getElementById('username').value.toUpperCase();
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('login-error');
            
            if (username === LOGIN_CORRETO && password === SENHA_CORRETA) {
                sessionStorage.setItem('isLoggedIn', 'true');
                errorMsg.style.display = 'none';
                checkLogin(); 
            } else {
                sessionStorage.setItem('isLoggedIn', 'false');
                errorMsg.style.display = 'block';
                document.getElementById('password').value = '';
            }
        }
        
        window.logout = function() {
            sessionStorage.removeItem('isLoggedIn');
            alert('Sess√£o encerrada com sucesso! Voltando para a tela inicial.');
            mostrarTelaHome(); 
        }

        function checkLogin() { 
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            
            if (isLoggedIn) {
                document.getElementById('home-screen').style.display = 'none';
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'block'; 
                
                pararRelogio(); 
                
                // CORRE√á√ÉO: Chama a fun√ß√£o globalmente acess√≠vel
                window.mostrarSecao('#dashboard'); 
                setTimeout(carregarDashboard, 50); 
               
            } else {
                mostrarTelaHome();
            }
        }
        
        /* ---------------------------------------------------- */
        /* WIDGETS E UTILIT√ÅRIOS DA HOME */
        /* ---------------------------------------------------- */

        function iniciarRelogioBrasilia() {
            pararRelogio(); 
            const divHorario = document.getElementById('horario-brasilia');

            function atualizarHorario() {
                const now = new Date();
                const options = {
                    timeZone: 'America/Sao_Paulo',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false 
                };
                const horaFormatada = now.toLocaleTimeString('pt-BR', options);
                const dataFormatada = now.toLocaleDateString('pt-BR', { timeZone: 'America/Sao_Paulo', day: '2-digit', month: 'long', year: 'numeric' });
                
                divHorario.innerHTML = `${horaFormatada} <span style="display: block; font-size: 0.5em; font-weight: normal; color: #BBDEFB;">${dataFormatada.toUpperCase()}</span>`;
            }

            atualizarHorario(); 
            horarioInterval = setInterval(atualizarHorario, 1000); 
        }

        /* ---------------------------------------------------- */
        /* FUN√á√ïES GERAIS DO PAINEL (CORRIGIDAS PARA ESCOPO GLOBAL) */
        /* ---------------------------------------------------- */

        // CORRE√á√ÉO DE ESCOPO: Fun√ß√µes declaradas no escopo global
        const formatarMoeda = (valor) => {
            return parseFloat(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };
        
        const formatarData = (dataString) => {
            if (!dataString) return '-';
            const partes = dataString.split('-');
            if (partes.length === 3) {
                const [ano, mes, dia] = partes;
                return `${dia}/${mes}/${ano}`;
            }
            return dataString; 
        };

        const calcularProximoVencimento = (dataBase) => {
            if (!dataBase) return '';

            const data = new Date(dataBase + 'T00:00:00'); 
            const diaOriginal = data.getDate();
            
            data.setMonth(data.getMonth() + 1);
            
            if (data.getDate() < diaOriginal) {
                data.setDate(0); 
            }

            const ano = data.getFullYear();
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const dia = String(data.getDate()).padStart(2, '0');
            
            return `${ano}-${mes}-${dia}`;
        };


        window.mostrarSecao = function(idSecao) { 
            const links = document.querySelectorAll('nav ul li a');
            const secoes = document.querySelectorAll('.secao');
            
            secoes.forEach(secao => { secao.style.display = 'none'; });
            const secaoAtiva = document.querySelector(idSecao);
            if (secaoAtiva) { secaoAtiva.style.display = 'block'; }
            
            links.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === idSecao) { link.classList.add('active'); }
            });

            if (idSecao === '#dashboard') {
                carregarDashboard();
            } else if (idSecao === '#dados-clientes') {
                carregarTabelaClientes();
                popularSelectClientes(); 
            } else if (idSecao === '#graficos') {
                // Aqui voc√™ pode chamar a fun√ß√£o do gr√°fico anual
            } else if (idSecao === '#historico-pagamentos') {
                carregarHistoricoPagamentos();
            }
        }
        
        // Fim das corre√ß√µes de escopo


        document.addEventListener('DOMContentLoaded', () => {
            const links = document.querySelectorAll('nav ul li a');
            const formCadastro = document.getElementById('cadastroClienteForm');
            const formRegistroRapido = document.getElementById('registroPagamentoForm'); 
            
            
            // Event Listeners dos links de navega√ß√£o
            links.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.mostrarSecao(link.getAttribute('href')); // Chama a fun√ß√£o global
                });
            });


            window.deletarCliente = async function(id) { 
                const clientes = await getClientesDoDatabase();
                const cliente = clientes.find(c => c.id === id);

                if (confirm(`TEM CERTEZA QUE DESEJA DELETAR O CLIENTE ${cliente.nome}?`)) {
                    await deletarClienteNoDatabase(id); 
                    
                    carregarTabelaClientes();
                    carregarDashboard(); 
                    popularSelectClientes();
                    alert('CLIENTE DELETADO COM SUCESSO!');
                }
            }
            
            window.editarCliente = async function(id) { 
                const clientes = await getClientesDoDatabase();
                let cliente = clientes.find(c => c.id === id); 
                
                const campos = [
                    'NOME', 'SERVI√áO', 'APP NOME', 'VALOR', 'VENCIMENTO', 
                    'PAGAMENTO', 'BANCO', 'OBSERVA√á√ïES'
                ];
                
                let promptMsg = `EDITAR CLIENTE: ${cliente.nome}\n\n`;
                promptMsg += "QUAL CAMPO DESEJA ALTERAR? Digite o NOME do campo (ex: NOME, VALOR, VENCIMENTO):\n\n";
                promptMsg += campos.join(', ');

                let campoParaEditar = prompt(promptMsg);
                
                if (campoParaEditar) {
                    campoParaEditar = campoParaEditar.toUpperCase().trim();
                    let valorAtual = '';
                    let chave = '';

                    switch (campoParaEditar) {
                        case 'NOME': chave = 'nome'; valorAtual = cliente.nome; break;
                        case 'SERVI√áO': chave = 'servico'; valorAtual = cliente.servico; break;
                        case 'APP NOME': chave = 'appNome'; valorAtual = cliente.appNome; break;
                        case 'VALOR': chave = 'valor'; valorAtual = cliente.valor; break;
                        case 'VENCIMENTO': chave = 'vencimento'; valorAtual = cliente.vencimento; break;
                        case 'PAGAMENTO': chave = 'pagamento'; valorAtual = cliente.pagamento; break;
                        case 'BANCO': chave = 'banco'; valorAtual = cliente.banco; break;
                        case 'OBSERVA√á√ïES': chave = 'observacoes'; valorAtual = cliente.observacoes; break;
                        default:
                            alert('CAMPO INV√ÅLIDO. TENTE NOVAMENTE.');
                            return;
                    }

                    const novoValor = prompt(`EDITANDO O CAMPO: ${campoParaEditar}\nVALOR ATUAL: ${valorAtual}\n\nDIGITE O NOVO VALOR:`);
                    
                    if (novoValor !== null) { 
                        let valorFinal = novoValor;

                        if (['nome', 'appNome', 'banco', 'observacoes'].includes(chave)) {
                            valorFinal = novoValor.toUpperCase();
                        }
                        
                        if (chave === 'valor' && valorFinal !== '') {
                            const valorNumerico = parseFloat(valorFinal.replace(',', '.'));
                            if (isNaN(valorNumerico)) {
                                alert('VALOR INV√ÅLIDO PARA O CAMPO VALOR. OPERA√á√ÉO CANCELADA.');
                                return;
                            }
                            valorFinal = valorNumerico.toFixed(2); 
                        }

                        cliente[chave] = valorFinal;
                        
                        await salvarClienteNoDatabase(cliente); 
                        
                        alert(`CAMPO ${campoParaEditar} DO CLIENTE ${cliente.nome} ATUALIZADO PARA: ${valorFinal}`);
                        carregarTabelaClientes();
                        carregarDashboard();
                        popularSelectClientes();
                    }
                }
            }


            window.atualizarDataPagamento = async function(id, dataInput) { 
                const clientes = await getClientesDoDatabase();
                const cliente = clientes.find(c => c.id === id);
                const dataPagamento = dataInput.value;
                
                cliente.dataPagamento = dataPagamento;
                
                if (dataPagamento) {
                    const proximoVencimento = calcularProximoVencimento(dataPagamento);
                    cliente.vencimento = proximoVencimento; 
                }
                
                await salvarClienteNoDatabase(cliente); 

                carregarHistoricoPagamentos(); 
                carregarTabelaClientes(); 
                carregarDashboard(); 
            }

            async function popularSelectClientes() { 
                const clientes = await getClientesDoDatabase();
                const select = document.getElementById('clientePagamento');
                
                select.innerHTML = '<option value="">SELECIONE O CLIENTE</option>'; 
                
                clientes.forEach((c) => {
                    const option = document.createElement('option');
                    option.value = c.id; 
                    option.textContent = `${c.nome} - PR√ìX. VENCIMENTO: ${formatarData(c.vencimento)}`;
                    select.appendChild(option);
                });
            }

            formRegistroRapido.addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                
                const clientes = await getClientesDoDatabase();
                const id = document.getElementById('clientePagamento').value;
                const cliente = clientes.find(c => c.id === id);


                if (!cliente) {
                    alert('POR FAVOR, SELECIONE UM CLIENTE V√ÅLIDO.');
                    return;
                }
                
                const dataPagamento = document.getElementById('dataPagamentoRapido').value;
                const formaPagamento = document.getElementById('pagamentoRapido').value;
                const banco = document.getElementById('bancoPagamentoRapido').value.toUpperCase(); 
                
                cliente.dataPagamento = dataPagamento;
                cliente.pagamento = formaPagamento; 
                cliente.banco = banco; 

                const proximoVencimento = calcularProximoVencimento(dataPagamento);
                cliente.vencimento = proximoVencimento; 
                
                await salvarClienteNoDatabase(cliente); 
                
                alert(`PAGAMENTO DE ${cliente.nome} REGISTRADO! PR√ìXIMA RENOVA√á√ÉO: ${formatarData(cliente.vencimento)}`);
                formRegistroRapido.reset(); 
                popularSelectClientes(); 
                carregarTabelaClientes();
                carregarDashboard();
                mostrarSecao('#dados-clientes'); 
            });


            async function carregarTabelaClientes() { 
                const clientes = await getClientesDoDatabase(); 
                const tabelaDiv = document.getElementById('tabela-dados-clientes');
                
                if (clientes.length === 0) {
                    tabelaDiv.innerHTML = '<p style="text-align: center; color: #e67e22;">NENHUM CLIENTE CADASTRADO AINDA.</p>';
                    return;
                }

                let html = '<table><thead><tr>';
                html += '<th>CLIENTE</th><th>SERVI√áO</th><th>VALOR (R$)</th><th>VENCIMENTO</th><th>A√á√ïES</th>'; 
                html += '</tr></thead><tbody>';

                clientes.forEach((c) => { 
                    html += '<tr>';
                    html += `<td>${c.nome}</td>`;
                    html += `<td>${c.servico}</td>`;
                    html += `<td>${formatarMoeda(c.valor)}</td>`;
                    html += `<td class="proxima-renovacao">${formatarData(c.vencimento)}</td>`; 
                    html += `<td>
                                <button class="botao-editar" onclick="editarCliente('${c.id}')">EDITAR</button>
                                <button class="botao-deletar" onclick="deletarCliente('${c.id}')">DEL</button>
                            </td>`; 
                    html += '</tr>';
                });

                html += '</tbody></table>';
                tabelaDiv.innerHTML = html;
            }

            window.carregarHistoricoPagamentos = async function() { 
                const clientes = await getClientesDoDatabase(); 
                const tabelaDiv = document.getElementById('tabela-historico');
                const filtro = document.getElementById('filtroPagamento').value; 

                const clientesFiltrados = clientes.filter(cliente => {
                    return filtro === 'todos' || cliente.pagamento === filtro;
                });

                if (clientesFiltrados.length === 0) {
                    tabelaDiv.innerHTML = `<p style="text-align: center; color: #e67e22;">NENHUM CLIENTE ENCONTRADO COM A FORMA DE PAGAMENTO: ${filtro}.</p>`;
                    return;
                }

                let html = '<table><thead><tr>';
                html += '<th>CLIENTE</th><th>VENCIMENTO</th><th>DATA PGTO</th><th>VALOR (R$)</th><th>FORMA</th>'; 
                html += '</tr></thead><tbody>';

                clientesFiltrados.forEach((c) => { 
                    
                    const dataPagamentoInput = `
                        <input 
                            type="date" 
                            style="width: 100px; padding: 5px; font-size: 0.8em;"
                            value="${c.dataPagamento || ''}"
                            onchange="atualizarDataPagamento('${c.id}', this)"
                        >
                    `;
                    
                    html += '<tr>';
                    html += `<td>${c.nome}</td>`;
                    html += `<td class="proxima-renovacao">${formatarData(c.vencimento)}</td>`; 
                    html += `<td>${dataPagamentoInput}</td>`;
                    html += `<td>${formatarMoeda(c.valor)}</td>`; 
                    html += `<td>${c.pagamento}</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                tabelaDiv.innerHTML = html;
            }
            
            // FUN√á√ÉO PRINCIPAL DO DASHBOARD
            window.carregarDashboard = async function() { 
                const clientes = await getClientesDoDatabase(); 
                let faturamentoTotal = 0;
                let vencimentosEsteMes = 0;
                let vencimentosProximoMes = 0;
                
                const dataAtual = new Date();
                const mesAtual = dataAtual.getMonth() + 1;
                const anoAtual = dataAtual.getFullYear();
                
                const mesProximo = mesAtual === 12 ? 1 : mesAtual + 1;
                const anoProximo = mesAtual === 12 ? anoAtual + 1 : anoAtual;
                
                const mesAtualNome = new Date(anoAtual, mesAtual - 1, 1).toLocaleDateString('pt-BR', { month: 'long' }).toUpperCase();
                const mesProximoNome = new Date(anoProximo, mesProximo - 1, 1).toLocaleDateString('pt-BR', { month: 'long' }).toUpperCase();
                
                let valorMesAtual = 0;
                let valorProximoMes = 0;

                document.getElementById('tituloMesAtual').innerText = mesAtualNome;
                document.getElementById('tituloProximoMes').innerText = mesProximoNome;

                clientes.forEach(cliente => {
                    faturamentoTotal += parseFloat(cliente.valor || 0);

                    if (cliente.vencimento) {
                        const partesVencimento = cliente.vencimento.split('-');
                        const anoVencimento = parseInt(partesVencimento[0]);
                        const mesVencimento = parseInt(partesVencimento[1]);

                        if (anoVencimento === anoAtual && mesVencimento === mesAtual) {
                            vencimentosEsteMes++;
                            valorMesAtual += parseFloat(cliente.valor || 0);
                        } 
                    }
                    
                    let dataBaseParaProximaPrevisao = cliente.vencimento;
                    
                    if (cliente.dataPagamento) {
                        const partesPagamento = cliente.dataPagamento.split('-');
                        const anoPagamento = parseInt(partesPagamento[0]);
                        const mesPagamento = parseInt(partesPagamento[1]);
                        
                        if (anoPagamento === anoAtual && mesPagamento === mesAtual) {
                            dataBaseParaProximaPrevisao = cliente.dataPagamento;
                        }
                    }

                    if (dataBaseParaProximaPrevisao) {
                         const proximoVencimentoPrevisto = calcularProximoVencimento(dataBaseParaProximaPrevisao);
                         const partesPrevisto = proximoVencimentoPrevisto.split('-');
                         const anoPrevisto = parseInt(partesPrevisto[0]);
                         const mesPrevisto = parseInt(partesPrevisto[1]);
                        
                        if (anoPrevisto === anoProximo && mesPrevisto === mesProximo) {
                            vencimentosProximoMes++;
                            valorProximoMes += parseFloat(cliente.valor || 0);
                        }
                    }

                });

                document.getElementById('valorFaturamento').innerText = formatarMoeda(faturamentoTotal);
                document.getElementById('valorClientes').innerText = clientes.length;
                document.getElementById('valorVencimentosMes').innerText = vencimentosEsteMes;
                document.getElementById('valorVencimentosProximoMes').innerText = vencimentosProximoMes; 
                
                // As fun√ß√µes de gr√°fico precisam ser definidas!
                // gerarGraficoVencimentosPorMes(mesAtual, mesProximo, anoAtual, anoProximo, clientes);
                // gerarGraficoDistribuicao(clientes);
            }
            
            // As fun√ß√µes de gr√°fico (gerarGraficoVencimentosPorMes, gerarGraficoDistribuicao, gerarGraficoVencimentosAnual)
            // precisam ser definidas para evitar erros.

            formCadastro.addEventListener('submit', async (e) => { // CORRE√á√ÉO: AGORA √â ASYNC
                e.preventDefault(); 

                const novoCliente = {
                    nome: document.getElementById('nome').value.toUpperCase(),
                    servico: document.getElementById('servico').value, 
                    appNome: document.getElementById('appNome').value.toUpperCase(),
                    valor: document.getElementById('valor').value,
                    vencimento: document.getElementById('vencimento').value,
                    pagamento: document.getElementById('pagamento').value,
                    banco: document.getElementById('banco').value.toUpperCase(),
                    renovacao: '30',
                    observacoes: document.getElementById('observacoes').value.toUpperCase(),
                    dataPagamento: '' 
                };

                await salvarClienteNoDatabase(novoCliente);
                
                formCadastro.reset();
                alert(`CLIENTE ${novoCliente.nome} CADASTRADO COM SUCESSO!`);
                window.mostrarSecao('#dados-clientes'); 
            });

            checkLogin();
        });
    </script>
</body>
</html>
