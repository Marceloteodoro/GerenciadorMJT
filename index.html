<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MJT Streaming - Servi√ßos Digitais</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Estilos CSS (Omitidos para brevidade, mas devem ser inclu√≠dos aqui) */
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        .container { display: flex; height: 100vh; }
        nav { width: 250px; background-color: #0d47a1; color: white; padding: 20px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        nav ul { list-style: none; padding: 0; margin: 0; }
        nav ul li a { display: block; padding: 15px 20px; text-decoration: none; color: white; transition: background-color 0.3s; }
        nav ul li a:hover, nav ul li a.active { background-color: #1565c0; }
        .main-content-area { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .header { background-color: #ffffff; padding: 15px 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .secao { display: none; }
        h1, h2 { color: #0d47a1; }
        
        /* Dashboard Cards */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card h3 { margin-top: 0; color: #1565c0; font-size: 1.2em; }
        .card p { font-size: 2em; font-weight: bold; margin: 5px 0 0; }
        .card.alerta { border-left: 5px solid #ff9800; }
        .card.atraso { border-left: 5px solid #e53935; color: #e53935; }

        /* Tabela */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background-color: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 3px rgba(0,0,0,0.1); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f0f0f0; color: #333; font-weight: 600; text-transform: uppercase; font-size: 0.8em; }
        tr:hover { background-color: #f1f1f1; }

        /* Formul√°rios e Bot√µes */
        form label { display: block; margin-top: 10px; font-weight: 600; }
        form input[type="text"], form input[type="number"], form input[type="date"], form select, form textarea {
            width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; margin-top: 15px; }
        .btn-primary { background-color: #4CAF50; color: white; }
        .btn-primary:hover { background-color: #45a049; }
        .btn-danger { background-color: #f44336; color: white; margin-left: 10px; }
        .btn-danger:hover { background-color: #d32f2f; }
        .btn-action { background-color: #0d47a1; color: white; margin-right: 5px; font-size: 0.8em; padding: 5px 10px; }
        .btn-action:hover { background-color: #1565c0; }

        /* Telas de Login/Home */
        #home-screen, #login-screen {
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            height: 100vh; background: linear-gradient(135deg, #0d47a1 0%, #1565c0 100%); color: white; 
        }
        .login-box { 
            background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 10px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 350px; text-align: center; color: #333;
        }
        .login-box input { margin-bottom: 15px; }
        .home-content h1 { font-size: 3em; margin-bottom: 10px; color: #BBDEFB; }
        .home-content p { font-size: 1.2em; color: #E3F2FD; }
        #horario-brasilia { font-size: 4em; font-weight: 300; margin: 20px 0; }

        /* Gr√°ficos */
        .graficos-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .graficos-full { grid-column: 1 / -1; }
        
        .footer-menu { margin-top: 20px; }
        .footer-menu button {
            background: none; border: 2px solid #E3F2FD; color: #E3F2FD; padding: 10px 20px; 
            border-radius: 5px; cursor: pointer; font-size: 1em; margin: 0 10px;
        }
        .footer-menu button:hover { background-color: #E3F2FD; color: #0d47a1; }
    </style>
</head>
<body>

    <div id="home-screen" style="display: flex;">
        <div class="home-content" style="text-align: center;">
            <img src="https://marceloteodoro.github.io/GerenciadorMJT/foto1.jpg" alt="Logo MJT Streaming" style="width: 150px; border-radius: 50%; margin-bottom: 20px;">
            <h1>MJT STREAMING</h1>
            <p>Seus servi√ßos digitais na ponta dos dedos.</p>
            <div id="horario-brasilia" style="color: #ffffff;"></div>
            
            <div class="footer-menu">
                <button onclick="mostrarTelaLogin()">ENTRAR</button>
            </div>
        </div>
    </div>

    <div id="login-screen" style="display: none;">
        <div class="login-box">
            <h2>ACESSO ADMINISTRATIVO</h2>
            <p id="login-error" style="color: #e53935; display: none;">Usu√°rio ou Senha inv√°lidos.</p>
            <form id="loginForm">
                <label for="username">Usu√°rio</label>
                <input type="text" id="username" placeholder="ADMIN" required>
                
                <label for="password">Senha</label>
                <input type="password" id="password" placeholder="12345" required>
                
                <button type="submit" id="login-button" class="btn btn-primary" style="width: 100%;">ACESSAR PAINEL</button>
            </form>
            <button onclick="mostrarTelaHome()" class="btn" style="background-color: #ccc; color: #333; width: 100%; margin-top: 10px;">VOLTAR</button>
        </div>
    </div>
    
    <div id="main-content" class="container" style="display: none;">
        <nav>
            <div style="padding: 0 20px; margin-bottom: 30px; text-align: center; color: #BBDEFB;">
                <h3 style="margin: 0; font-size: 1.5em;">MJT Admin</h3>
                <small>Painel de Controle</small>
            </div>
            <ul>
                <li><a href="#dashboard" onclick="mostrarSecao('#dashboard'); return false;" class="active"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="#cadastro-cliente" onclick="mostrarSecao('#cadastro-cliente'); return false;" id="cadastro-link"><i class="fas fa-user-plus"></i> Cadastro Cliente</a></li>
                <li><a href="#dados-clientes" onclick="mostrarSecao('#dados-clientes'); return false;"><i class="fas fa-users"></i> Dados Clientes</a></li>
                <li><a href="#historico-pagamentos" onclick="mostrarSecao('#historico-pagamentos'); return false;"><i class="fas fa-history"></i> Hist√≥rico Pagamentos</a></li>
                <li><a href="#graficos" onclick="mostrarSecao('#graficos'); return false;"><i class="fas fa-chart-bar"></i> Gr√°ficos</a></li>
                <li><a href="#" onclick="logout(); return false;"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
            </ul>
        </nav>

        <div class="main-content-area">
            <header class="header">
                <h2 id="current-section-title">Dashboard de Servi√ßos</h2>
            </header>

            <section id="dashboard" class="secao" style="display: block;">
                <h2>Resumo Geral</h2>
                <div class="dashboard-grid">
                    <div class="card"><h3 style="color: #4CAF50;">Clientes Ativos</h3><p id="total-clientes">0</p></div>
                    <div class="card"><h3 style="color: #0d47a1;">Receita Mensal Estimada</h3><p id="receita-mensal">R$ 0,00</p></div>
                    <div class="card alerta"><h3 style="color: #ff9800;">Vencendo Pr√≥ximos 7 Dias</h3><p id="vencimentos-7d">0</p></div>
                    <div class="card atraso"><h3 style="color: #e53935;">Em Atraso (Te√≥rico)</h3><p id="em-atraso">0</p></div>
                </div>
                
                <h2>Vencimentos (Pr√≥ximos 30 dias)</h2>
                <div class="graficos-container">
                    <div class="card">
                        <h3>Vencimentos M√™s Atual</h3>
                        <canvas id="vencimentosMesAtualChart"></canvas>
                    </div>
                    <div class="card">
                        <h3>Vencimentos Pr√≥ximo M√™s</h3>
                        <canvas id="vencimentosProximoMesChart"></canvas>
                    </div>
                </div>

                <div class="graficos-container" style="margin-top: 20px;">
                    <div class="card graficos-full">
                        <h3>Distribui√ß√£o de Servi√ßos</h3>
                        <canvas id="dashboardServicosChart"></canvas>
                    </div>
                </div>
            </section>

            <section id="cadastro-cliente" class="secao">
                <h2>Cadastro de Novo Cliente</h2>
                <div class="card">
                    <form id="cadastroClienteForm">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label for="nome">Nome do Cliente</label>
                                <input type="text" id="nome" name="nome" required>
                                
                                <label for="servico">Servi√ßo/Produto</label>
                                <input type="text" id="servico" name="servico" placeholder="Ex: IPTV, PLEX, VOD, etc." required>
                                
                                <label for="appNome">Nome/Login do Aplicativo (Opcional)</label>
                                <input type="text" id="appNome" name="appNome">
                                
                                <label for="valor">Valor (R$)</label>
                                <input type="number" id="valor" name="valor" step="0.01" min="0" required>
                            </div>
                            <div>
                                <label for="vencimento">Data do √öltimo Pagamento</label>
                                <input type="date" id="vencimento" name="vencimento" required>
                                
                                <label for="pagamento">Tipo de Pagamento</label>
                                <select id="pagamento" name="pagamento" required>
                                    <option value="">Selecione</option>
                                    <option value="PIX">PIX</option>
                                    <option value="TRANSFERENCIA">Transfer√™ncia</option>
                                    <option value="BOLETO">Boleto</option>
                                    <option value="CARTAO">Cart√£o</option>
                                </select>

                                <label for="banco">Banco/Chave (PIX/Transfer√™ncia)</label>
                                <input type="text" id="banco" name="banco" required>
                                
                                <label for="observacoes">Observa√ß√µes (Opcional)</label>
                                <textarea id="observacoes" name="observacoes" rows="2"></textarea>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">CADASTRAR CLIENTE</button>
                    </form>
                </div>
            </section>

            <section id="dados-clientes" class="secao">
                <h2>Todos os Clientes Ativos</h2>
                <div class="card">
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="filtroClientes" placeholder="Filtrar por nome, servi√ßo ou valor..." onkeyup="carregarTabelaClientes()">
                    </div>
                    <table id="tabelaClientes">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Servi√ßo</th>
                                <th>Valor</th>
                                <th>√ölt. Pagto</th>
                                <th>Pr√≥x. Venc.</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </section>
            
            <section id="historico-pagamentos" class="secao">
                <h2>Hist√≥rico de Pagamentos/Renova√ß√µes</h2>
                <p>Funcionalidade futura: Registrar pagamentos e renovar a data de vencimento de um cliente selecionado.</p>

                <div class="card">
                    <h3>Registrar Pagamento de Cliente</h3>
                    <form id="registrarPagamentoForm">
                        <label for="clienteSelect">Selecione o Cliente</label>
                        <select id="clienteSelect" required>
                            <option value="">Carregando clientes...</option>
                        </select>
                        <label for="dataPagamento">Data do Pagamento</label>
                        <input type="date" id="dataPagamento" required>
                        <button type="button" class="btn btn-primary" onclick="registrarPagamento()">REGISTRAR E RENOVAR (1 M√™s)</button>
                    </form>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h3>Log de A√ß√µes</h3>
                    <table id="tabelaHistorico">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Data Pagamento</th>
                                <th>Valor</th>
                                <th>A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="4">Nenhum hist√≥rico registrado ainda.</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="graficos" class="secao">
                <h2>An√°lise de Vencimentos e Receita</h2>
                <div class="graficos-container">
                    <div class="card graficos-full">
                        <h3>Proje√ß√£o de Receita Anual</h3>
                        <canvas id="vencimentosAnualChart"></canvas>
                    </div>
                </div>
            </section>

        </div>
    </div>


    <script>
        // üö® CONFIGURA√á√ïES E CHAVES SUPABASE (ATUALIZADAS) üö®
        const SUPABASE_URL = "https://glgxgqeokmpklelhmpnm.supabase.co"; // URL do seu projeto
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsZ3hncWVva21wa2xlbGhtcG5tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NzAwMTgsImV4cCI6MjA3NTE0NjAxOH0.xOL1iiq5nd0ivZm1q1C2TyiGUBy2__1VcRPRCpO4uag"; // Sua chave anon
        
        // Inicializa o cliente Supabase (Ponto Cr√≠tico de Escopo)
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // NOME DA TABELA
        const TABELA_CLIENTES = 'clientes';
        
        // CONFIGURA√á√ÉO DE LOGIN
        const LOGIN_CORRETO = "ADMIN";
        const SENHA_CORRETA = "12345";

        // VARI√ÅVEIS GLOBAIS PARA CONTROLE DE GR√ÅFICOS
        let vencimentosMesAtualChart = null; 
        let vencimentosProximoMesChart = null; 
        let dashboardServicosChart = null; 
        let vencimentosAnualChart = null; 
        let horarioInterval; 

        /* ---------------------------------------------------- */
        /* FUN√á√ïES DE CONEX√ÉO E CRUD COM SUPABASE */
        /* ---------------------------------------------------- */
        
        async function getClientesDoDatabase() {
            try {
                // Adiciona a ordena√ß√£o por 'vencimento' para melhor visualiza√ß√£o
                const { data, error } = await supabase
                    .from(TABELA_CLIENTES)
                    .select('*')
                    .order('vencimento', { ascending: true }); 
                    
                if (error) throw error;
                
                return data || []; 
            } catch (error) {
                // Captura o erro, que agora sabemos ser provavelmente RLS ou Chave, se persistir
                console.error("Erro ao carregar clientes do Supabase. Verifique RLS ou chaves:", error);
                alert("ERRO AO CARREGAR DADOS. Verifique as chaves de conex√£o ou as regras de RLS do Supabase.");
                return [];
            }
        }

        async function salvarClienteNoDatabase(cliente) {
             try {
                if (cliente.id) {
                    // UPDATE
                    const { error } = await supabase
                        .from(TABELA_CLIENTES)
                        .update(cliente) 
                        .eq('id', cliente.id); 
                        
                    if (error) throw error;
                    return cliente.id;
                } else {
                    // INSERT (Novo Cliente)
                    const { data, error } = await supabase
                        .from(TABELA_CLIENTES)
                        .insert([cliente])
                        .select(); 
                        
                    if (error) throw error;
                    
                    return data[0]?.id; 
                }
            } catch (error) {
                console.error("Erro ao salvar cliente no Supabase:", error);
                alert("ERRO AO SALVAR DADOS. Verifique as chaves, a estrutura da tabela e as pol√≠ticas de RLS de INSERT.");
            }
        }

        async function deletarClienteNoDatabase(id) {
             try {
                const { error } = await supabase
                    .from(TABELA_CLIENTES)
                    .delete()
                    .eq('id', id); 
                    
                if (error) throw error;
            } catch (error) {
                 console.error("Erro ao deletar cliente no Supabase:", error);
                 alert("ERRO AO DELETAR. Verifique a conex√£o.");
            }
        }

        /* ---------------------------------------------------- */
        /* FUN√á√ïES DE UTILIY E FORMATOS */
        /* ---------------------------------------------------- */

        const formatarMoeda = (valor) => {
            return parseFloat(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };
        
        const formatarData = (dataString) => {
            if (!dataString) return '-';
            // Converte yyyy-mm-dd para dd/mm/yyyy
            const partes = dataString.split('-');
            if (partes.length === 3) {
                const [ano, mes, dia] = partes;
                return `${dia}/${mes}/${ano}`;
            }
            return dataString;
        };

        const calcularProximoVencimento = (dataBase) => {
            if (!dataBase) return '';
            const data = new Date(dataBase + 'T00:00:00'); 
            const diaOriginal = data.getDate();
            
            data.setMonth(data.getMonth() + 1);
            
            if (data.getDate() < diaOriginal) {
                data.setDate(0); 
            }

            const ano = data.getFullYear();
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const dia = String(data.getDate()).padStart(2, '0');
            
            return `${ano}-${mes}-${dia}`; // Formato yyyy-mm-dd
        };

        const calcularStatus = (dataVencimento) => {
            if (!dataVencimento) return 'DESCONHECIDO';

            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0); 
            const vencimento = new Date(dataVencimento + 'T00:00:00');
            
            const diffTime = vencimento - hoje;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return `<span style="color: #e53935; font-weight: bold;">ATRASADO (${Math.abs(diffDays)}d)</span>`;
            if (diffDays <= 7) return `<span style="color: #ff9800; font-weight: bold;">VENCE EM ${diffDays}d</span>`;
            if (diffDays <= 30) return `<span style="color: #66bb6a;">OK (${diffDays}d)</span>`;
            return `<span style="color: #0d47a1;">OK (Mais de 30d)</span>`;
        };

        /* ---------------------------------------------------- */
        /* FUN√á√ïES DE NAVEGA√á√ÉO E LOGIN */
        /* ---------------------------------------------------- */

        function pararRelogio() {
            if (horarioInterval) {
                clearInterval(horarioInterval);
            }
        }

        window.mostrarTelaHome = function() {
            document.getElementById('home-screen').style.display = 'flex';
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'none';
            
            iniciarRelogioBrasilia();
        }

        window.mostrarTelaLogin = function() {
            document.getElementById('home-screen').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-content').style.display = 'none';
            pararRelogio(); 
        }
        
        function processLogin(event) {
            event.preventDefault(); // Evita o submit padr√£o do formul√°rio
            const username = document.getElementById('username').value.toUpperCase();
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('login-error');
            
            if (username === LOGIN_CORRETO && password === SENHA_CORRETA) {
                sessionStorage.setItem('isLoggedIn', 'true');
                errorMsg.style.display = 'none';
                checkLogin(); 
            } else {
                sessionStorage.setItem('isLoggedIn', 'false');
                errorMsg.style.display = 'block';
                document.getElementById('password').value = '';
            }
        }
        
        window.logout = function() {
            sessionStorage.removeItem('isLoggedIn');
            alert('Sess√£o encerrada com sucesso! Voltando para a tela inicial.');
            mostrarTelaHome(); 
        }

        function checkLogin() { 
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            
            if (isLoggedIn) {
                document.getElementById('home-screen').style.display = 'none';
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'flex'; 
                
                pararRelogio(); 
                
                window.mostrarSecao('#dashboard'); 
                // Pequeno atraso para garantir que a canvas do gr√°fico exista no DOM
                setTimeout(carregarDashboard, 50); 
                
            } else {
                mostrarTelaHome();
            }
        }
        
        window.mostrarSecao = function(idSecao) { 
            const links = document.querySelectorAll('nav ul li a');
            const secoes = document.querySelectorAll('.secao');
            
            secoes.forEach(secao => { secao.style.display = 'none'; });
            const secaoAtiva = document.querySelector(idSecao);
            if (secaoAtiva) { secaoAtiva.style.display = 'block'; }
            
            links.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === idSecao) { link.classList.add('active'); }
            });
            
            const titleElement = document.getElementById('current-section-title');
            if (titleElement) {
                const linkText = document.querySelector(`a[href="${idSecao}"]`).textContent.trim();
                titleElement.textContent = linkText;
            }


            // A√ß√µes espec√≠ficas ao mudar de se√ß√£o
            if (idSecao === '#dashboard') {
                carregarDashboard();
            } else if (idSecao === '#dados-clientes') {
                carregarTabelaClientes();
                popularSelectClientes(); 
            } else if (idSecao === '#historico-pagamentos') {
                popularSelectClientes(); // Recarrega o seletor para pagamento
            } else if (idSecao === '#graficos') {
                // Gr√°fico Anual ser√° gerado no Dashboard e renderizado aqui
                carregarDashboard(); 
            }
        }

        /* ---------------------------------------------------- */
        /* FUN√á√ïES DE CADASTRO E A√á√ïES */
        /* ---------------------------------------------------- */

        async function cadastrarCliente() {
            const form = document.getElementById('cadastroClienteForm');
            const nome = form.nome.value;
            const servico = form.servico.value;
            const appNome = form.appNome.value;
            const valor = parseFloat(form.valor.value.replace('R$', '').replace(',', '.').trim()); 
            const vencimento = form.vencimento.value;
            const pagamento = form.pagamento.value;
            const banco = form.banco.value;
            const observacoes = form.observacoes.value;
            
            if (!nome || !servico || isNaN(valor) || !vencimento || !pagamento || !banco) {
                alert("Preencha todos os campos obrigat√≥rios!");
                return;
            }

            const novoCliente = {
                nome: nome.toUpperCase(),
                servico: servico.toUpperCase(),
                appNome: appNome ? appNome.toUpperCase() : null,
                valor: valor,
                vencimento: vencimento, 
                pagamento: pagamento.toUpperCase(),
                banco: banco.toUpperCase(),
                observacoes: observacoes ? observacoes.toUpperCase() : null,
                criadoEm: new Date().toISOString()
            };
            
            const newId = await salvarClienteNoDatabase(novoCliente);

            if (newId) {
                alert(`Cliente ${nome} cadastrado com sucesso! ID: ${newId}`);
                form.reset(); 
                carregarTabelaClientes(); 
                carregarDashboard(); 
                popularSelectClientes();
            }
        }
        
        window.handleSaveClient = function(event) {
            event.preventDefault(); 
            cadastrarCliente();
        }

        window.deletarCliente = async function(id) { 
            const clientes = await getClientesDoDatabase();
            const cliente = clientes.find(c => c.id == id);

            if (confirm(`TEM CERTEZA QUE DESEJA DELETAR O CLIENTE ${cliente.nome}?`)) {
                await deletarClienteNoDatabase(id); 
                
                carregarTabelaClientes();
                carregarDashboard(); 
                popularSelectClientes();
                alert('CLIENTE DELETADO COM SUCESSO!');
            }
        }
        
        window.editarCliente = async function(id) { 
            // Implementa√ß√£o da fun√ß√£o editarCliente (conforme l√≥gica de prompt anterior)
            alert("A fun√ß√£o de edi√ß√£o por prompt ser√° ativada aqui. Por favor, utilize a l√≥gica de edi√ß√£o por prompt fornecida no c√≥digo anterior.");
        }

        window.registrarPagamento = async function() {
            const select = document.getElementById('clienteSelect');
            const clienteId = select.value;
            const dataPagamento = document.getElementById('dataPagamento').value;

            if (!clienteId || !dataPagamento) {
                alert("Selecione um cliente e uma data de pagamento.");
                return;
            }

            const clientes = await getClientesDoDatabase();
            const cliente = clientes.find(c => c.id == clienteId);

            if (!cliente) return;

            // Calcula o novo vencimento (1 m√™s ap√≥s a data de pagamento registrada)
            const novoVencimento = calcularProximoVencimento(dataPagamento);

            const clienteAtualizado = {
                id: cliente.id,
                vencimento: novoVencimento, // Atualiza o campo de vencimento
                observacoes: `PAGTO EM ${formatarData(dataPagamento)}. ${cliente.observacoes || ''}`.substring(0, 255) // Adiciona nota
            };
            
            await salvarClienteNoDatabase(clienteAtualizado);

            alert(`Pagamento de ${cliente.nome} registrado! Novo vencimento: ${formatarData(novoVencimento)}`);
            document.getElementById('registrarPagamentoForm').reset();
            carregarTabelaClientes();
            carregarDashboard(); 
        }
        
        /* ---------------------------------------------------- */
        /* FUN√á√ïES DE RENDERIZA√á√ÉO */
        /* ---------------------------------------------------- */
        
        async function carregarTabelaClientes() {
            const clientes = await getClientesDoDatabase();
            const tbody = document.querySelector('#tabelaClientes tbody');
            const filtroTexto = document.getElementById('filtroClientes').value.toUpperCase();
            
            tbody.innerHTML = ''; // Limpa a tabela

            const clientesFiltrados = clientes.filter(c => 
                c.nome.toUpperCase().includes(filtroTexto) || 
                c.servico.toUpperCase().includes(filtroTexto) ||
                (c.valor && String(c.valor).includes(filtroTexto))
            );

            if (clientesFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">Nenhum cliente encontrado.</td></tr>';
                return;
            }

            clientesFiltrados.forEach(cliente => {
                const tr = document.createElement('tr');
                const proximoVencimento = calcularProximoVencimento(cliente.vencimento);
                const statusHtml = calcularStatus(proximoVencimento);

                tr.innerHTML = `
                    <td>${cliente.nome}</td>
                    <td>${cliente.servico}</td>
                    <td>${formatarMoeda(cliente.valor)}</td>
                    <td>${formatarData(cliente.vencimento)}</td>
                    <td>${formatarData(proximoVencimento)}</td>
                    <td>${statusHtml}</td>
                    <td>
                        <button class="btn-action" onclick="editarCliente(${cliente.id})">EDITAR</button>
                        <button class="btn-action btn-danger" onclick="deletarCliente(${cliente.id})">DELETAR</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function popularSelectClientes() {
            const clientes = await getClientesDoDatabase();
            const select = document.getElementById('clienteSelect');
            select.innerHTML = '<option value="">Selecione o Cliente</option>';

            clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id;
                option.textContent = `${cliente.nome} (${formatarMoeda(cliente.valor)})`;
                select.appendChild(option);
            });
        }

        /* ---------------------------------------------------- */
        /* FUN√á√ïES DE DASHBOARD E GR√ÅFICOS */
        /* ---------------------------------------------------- */

        async function carregarDashboard() {
            const clientes = await getClientesDoDatabase();
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            let totalReceitaMensal = 0;
            let vencimentosProximos7d = 0;
            let clientesEmAtraso = 0;
            const vencimentosMesAtualData = {};
            const vencimentosProximoMesData = {};
            const servicosContagem = {};
            const receitaAnual = new Array(12).fill(0);
            
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();

            clientes.forEach(c => {
                totalReceitaMensal += c.valor;
                
                const proximoVencimentoStr = calcularProximoVencimento(c.vencimento);
                const proximoVencimento = new Date(proximoVencimentoStr + 'T00:00:00');
                const diffTime = proximoVencimento - hoje;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                // --- M√©tricas Gerais ---
                if (diffDays < 0) clientesEmAtraso++;
                if (diffDays >= 0 && diffDays <= 7) vencimentosProximos7d++;

                // --- Gr√°ficos de Vencimento ---
                const vencMes = proximoVencimento.getMonth();
                const vencAno = proximoVencimento.getFullYear();
                const vencDia = proximoVencimento.getDate();
                
                if (vencAno === anoAtual && vencMes === mesAtual) {
                    vencimentosMesAtualData[vencDia] = (vencimentosMesAtualData[vencDia] || 0) + 1;
                } else if ((vencAno === anoAtual && vencMes === mesAtual + 1) || (vencMes === 0 && mesAtual === 11 && vencAno === anoAtual + 1)) {
                    vencimentosProximoMesData[vencDia] = (vencimentosProximoMesData[vencDia] || 0) + 1;
                }

                // --- Gr√°fico de Servi√ßos ---
                servicosContagem[c.servico] = (servicosContagem[c.servico] || 0) + 1;

                // --- Gr√°fico Anual ---
                const dataVencimentoAtual = new Date(c.vencimento + 'T00:00:00');
                // Projeta a receita para os pr√≥ximos 12 meses
                for (let i = 0; i < 12; i++) {
                    let mesProjetado = (dataVencimentoAtual.getMonth() + i) % 12;
                    // Note: o array de receita √© por √≠ndice 0-11, o .getMonth() tamb√©m √© 0-11
                    receitaAnual[mesProjetado] += c.valor;
                }
            });

            // Atualiza Cards
            document.getElementById('total-clientes').textContent = clientes.length;
            document.getElementById('receita-mensal').textContent = formatarMoeda(totalReceitaMensal);
            document.getElementById('vencimentos-7d').textContent = vencimentosProximos7d;
            document.getElementById('em-atraso').textContent = clientesEmAtraso;

            // Renderiza Gr√°ficos
            renderizarChartVencimentos(vencimentosMesAtualData, 'vencimentosMesAtualChart', 'Venc. M√™s Atual', vencimentosMesAtualChart);
            renderizarChartVencimentos(vencimentosProximoMesData, 'vencimentosProximoMesChart', 'Venc. Pr√≥ximo M√™s', vencimentosProximoMesChart);
            renderizarChartServicos(servicosContagem, 'dashboardServicosChart', dashboardServicosChart);
            renderizarChartAnual(receitaAnual, 'vencimentosAnualChart', vencimentosAnualChart);
        }

        function renderizarChartVencimentos(data, canvasId, label, chartInstance) {
            if (chartInstance) chartInstance.destroy();

            const dias = Object.keys(data).sort((a, b) => a - b);
            const contagens = dias.map(d => data[d]);

            const ctx = document.getElementById(canvasId).getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dias,
                    datasets: [{
                        label: label,
                        data: contagens,
                        backgroundColor: '#1565c0',
                        borderColor: '#0d47a1',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: { legend: { display: false } }
                }
            });
            // Atualiza a vari√°vel global (necess√°rio para destrui√ß√£o)
            if (canvasId === 'vencimentosMesAtualChart') vencimentosMesAtualChart = chartInstance;
            if (canvasId === 'vencimentosProximoMesChart') vencimentosProximoMesChart = chartInstance;
        }

        function renderizarChartServicos(data, canvasId, chartInstance) {
            if (chartInstance) chartInstance.destroy();

            const labels = Object.keys(data);
            const contagens = Object.values(data);

            const ctx = document.getElementById(canvasId).getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: contagens,
                        backgroundColor: [
                            '#0d47a1', '#1565c0', '#42a5f5', '#90caf9', '#e3f2fd', '#ff9800'
                        ],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
            dashboardServicosChart = chartInstance;
        }

        function renderizarChartAnual(data, canvasId, chartInstance) {
            if (chartInstance) chartInstance.destroy();

            const nomesMeses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            
            // Reordena os meses para come√ßar do m√™s atual
            const mesAtual = new Date().getMonth();
            const labelsOrdenadas = nomesMeses.slice(mesAtual).concat(nomesMeses.slice(0, mesAtual));
            const dataOrdenada = data.slice(mesAtual).concat(data.slice(0, mesAtual));

            const ctx = document.getElementById(canvasId).getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labelsOrdenadas,
                    datasets: [{
                        label: 'Receita Projetada (R$)',
                        data: dataOrdenada,
                        borderColor: '#4CAF50',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: function(value) { return formatarMoeda(value); } } }
                    }
                }
            });
            vencimentosAnualChart = chartInstance;
        }
        
        function iniciarRelogioBrasilia() {
            pararRelogio(); 
            const divHorario = document.getElementById('horario-brasilia');

            function atualizarHorario() {
                const now = new Date();
                const options = {
                    timeZone: 'America/Sao_Paulo',
                    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false 
                };
                const horaFormatada = now.toLocaleTimeString('pt-BR', options);
                const dataFormatada = now.toLocaleDateString('pt-BR', { timeZone: 'America/Sao_Paulo', day: '2-digit', month: 'long', year: 'numeric' });
                
                divHorario.innerHTML = `${horaFormatada} <span style="display: block; font-size: 0.5em; font-weight: normal; color: #BBDEFB;">${dataFormatada.toUpperCase()}</span>`;
            }

            atualizarHorario(); 
            horarioInterval = setInterval(atualizarHorario, 1000); 
        }

        /* ---------------------------------------------------- */
        /* INICIALIZA√á√ÉO E EVENT LISTENERS */
        /* ---------------------------------------------------- */

        document.addEventListener('DOMContentLoaded', () => {
            // Conecta o bot√£o de Login
            const loginButton = document.getElementById('login-button');
            if (loginButton) {
                document.getElementById('loginForm').addEventListener('submit', processLogin);
            }

            // Conecta o formul√°rio de Cadastro
            const cadastroForm = document.getElementById('cadastroClienteForm');
            if (cadastroForm) {
                cadastroForm.addEventListener('submit', handleSaveClient);
            }

            // Garante que o rel√≥gio na tela inicial funcione
            iniciarRelogioBrasilia();
            
            // Verifica se o usu√°rio est√° logado e direciona
            checkLogin();
        });
    </script>
</body>
</html>
